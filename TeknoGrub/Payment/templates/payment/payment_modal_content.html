{% load static %}

<div class="modal-box-content" style="position:relative;">

    <!-- Exit Button (CRITICAL FIX: Ensure this button is always visible) -->
    <button onclick="closePaymentModal()" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#333;">&times;</button>

    <h3 style="font-weight:700; font-size:1.5rem; color:#550508; margin-bottom:15px;">Payment Methods</h3>

    <!-- LIST EXISTING PAYMENT METHODS -->
    <div class="payment-methods-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
        {% for method in request.user.payment_methods.all %}
        <div class="payment-card" style="background:#F8F8F8; border-radius:8px; padding:15px; display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <div class="card-left" style="display:flex; align-items:center; gap:15px;">

                {% if method.method_type == 'GCash' %}
                    <img class="card-logo" src="https://upload.wikimedia.org/wikipedia/commons/5/52/GCash_logo.svg" alt="Gcash" style="width:40px; height:30px;">
                {% else %}
                    <i class="fa-brands fa-cc-visa" style="font-size:30px; color:blue;"></i>
                {% endif %}

                <div class="card-info" style="display:flex; flex-direction:column;">
                    <div class="card-title" style="font-weight:700; color:#550508; font-size:1rem;">
                        {% if method.method_type == 'GCash' %}
                            GCash {{ method.account_number|slice:":4" }} *** **{{ method.account_number|slice:"-2:" }}
                        {% else %}
                            Visa **** **** **** {{ method.masked_card_number }}
                        {% endif %}
                    </div>
                    {% if method.is_default %}
                        <div class="card-subtitle" style="font-size:0.8rem; color:#8B0000; font-weight:600;">Set as Default</div>
                    {% endif %}
                </div>
            </div>

            <div class="card-actions" style="display:flex; gap:15px; align-items:center;">
                <a href="{% url 'delete_payment' method.id %}"
                   onclick="return confirm('Delete this method?');"
                   style="color:#d32f2f;">
                    <i class="fa-solid fa-trash"></i>
                </a>
                <a href="#" style="color:#550508;"><i class="fa-solid fa-pen"></i></a>
            </div>
        </div>
        {% empty %}
        <p style="text-align:center; color:#888;">No payment methods saved.</p>
        {% endfor %}
    </div>

    <!-- ADD NEW PAYMENT METHOD FORM -->
    <h3 class="section-header" style="font-size:1.2rem; font-weight:700; color:#3E0000; margin-top:10px; margin-bottom:15px;">Add Payment Method</h3>

    <form method="POST" action="{% url 'add_payment_method' %}" id="payment-add-form" style="display:flex; flex-direction:column; gap:15px;">
        {% csrf_token %}

        <!-- Tab selection for Card/GCash -->
        <div class="payment-tabs" style="display: flex; gap: 10px;">
            <button type="button" onclick="showPaymentForm('card')" id="tab-card" class="tab-btn" style="flex:1; padding:10px; border:1px solid #ddd; background:#FBCD36;">Credit/Debit Card</button>
            <button type="button" onclick="showPaymentForm('gcash')" id="tab-gcash" class="tab-btn" style="flex:1; padding:10px; border:1px solid #ddd; background:white;">GCash</button>
        </div>

        <input type="hidden" name="method_type" value="Card" id="payment-method-type">

        <!-- Card Form Fields -->
        <div id="card-fields">
            <input type="text" name="card_number" class="styled-input" placeholder="Card Number" required>
            <div style="display:flex; gap:15px;">
                <input type="text" name="expiry" class="styled-input" placeholder="MM/YY" required style="flex:1;">
                <input type="text" name="cvv" class="styled-input" placeholder="CVV" required style="flex:1;">
            </div>
        </div>

        <!-- GCash Form Fields -->
        <div id="gcash-fields" style="display:none;">
            <input type="text" name="gcash_number" class="styled-input" placeholder="GCash Mobile Number (09xxxxxxxxx)" required>
        </div>

        <!-- Set as Default Checkbox -->
        <label style="display:flex; align-items:center; gap:10px; font-size:0.9rem; color:#555 !important;">
            <input type="checkbox" name="is_default" value="true" checked>
            <span style="color:#555;">Set as Default</span>
        </label>

        <button type="button" onclick="document.getElementById('payment-add-form').submit();" class="btn-add" style="background-color:#FBCD36; color:#550508; font-weight:700; font-size:1.1rem; padding:12px; border-radius:8px; border:none; cursor:pointer;">
            Add
        </button>
    </form>
</div>

<script>
    // Initial State Setup
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the initial state is Card
        showPaymentForm('card');
    });

    // Tab Switching Logic
    function showPaymentForm(type) {
        document.getElementById('payment-method-type').value = (type === 'card' ? 'Card' : 'GCash');
        document.getElementById('card-fields').style.display = (type === 'card' ? 'block' : 'none');
        document.getElementById('gcash-fields').style.display = (type === 'gcash' ? 'block' : 'none');

        // Aesthetic Tab Styling (Active tab is yellow)
        document.getElementById('tab-card').style.background = (type === 'card' ? '#FBCD36' : 'white');
        document.getElementById('tab-gcash').style.background = (type === 'gcash' ? '#FBCD36' : 'white');

        document.getElementById('tab-card').style.color = (type === 'card' ? '#550508' : '#555');
        document.getElementById('tab-gcash').style.color = (type === 'gcash' ? '#550508' : '#555');
    }
</script>
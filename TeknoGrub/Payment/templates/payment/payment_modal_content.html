{% load static %}

<div class="modal-box-content" style="position:relative;">

    <!-- Exit Button -->
    <button onclick="closePaymentModal()" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#333;">&times;</button>

    <h3 style="font-weight:700; font-size:1.5rem; color:#550508; margin-bottom:15px;">Payment Methods</h3>

    <!-- LIST EXISTING PAYMENT METHODS -->
    <div class="payment-methods-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
        {% for method in request.user.payment_methods.all %}
        <div class="payment-card" style="background:#F8F8F8; border-radius:8px; padding:15px; display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <div class="card-left" style="display:flex; align-items:center; gap:15px;">
                {% if method.method_type == 'GCash' %}
                    <img class="card-logo" src="https://upload.wikimedia.org/wikipedia/commons/5/52/GCash_logo.svg" alt="Gcash" style="width:40px; height:30px;">
                {% else %}
                    <i class="fa-brands fa-cc-visa" style="font-size:30px; color:blue;"></i>
                {% endif %}
                <div class="card-info" style="display:flex; flex-direction:column;">
                    <div class="card-title" style="font-weight:700; color:#550508; font-size:1rem;">
                        {% if method.method_type == 'GCash' %}
                            GCash {{ method.account_number|slice:":4" }} *** **{{ method.account_number|slice:"-2:" }}
                        {% else %}
                            Visa **** **** **** {{ method.masked_card_number }}
                        {% endif %}
                    </div>
                    {% if method.is_default %}
                        <div class="card-subtitle" style="font-size:0.8rem; color:#8B0000; font-weight:600;">Set as Default</div>
                    {% else %}
                        <a href="{% url 'set_default_payment' method.id %}" class="set-default-link">Set as Default</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-actions" style="display:flex; gap:15px; align-items:center;">
                <a href="{% url 'delete_payment' method.id %}"
                   onclick="return confirm('Delete this method?');"
                   style="color:#d32f2f;">
                    <i class="fa-solid fa-trash"></i>
                </a>
            </div>
        </div>
        {% empty %}
        <p style="text-align:center; color:#888;">No payment methods saved.</p>
        {% endfor %}
    </div>

    <!-- ADD NEW PAYMENT METHOD FORM -->
    <h3 class="section-header" style="font-size:1.2rem; font-weight:700; color:#3E0000; margin-top:10px; margin-bottom:15px;">Add Payment Method</h3>

    <form method="POST" action="{% url 'add_payment_method' %}" id="payment-add-form" style="display:flex; flex-direction:column; gap:15px;" onsubmit="return validatePaymentForm()">
        {% csrf_token %}

        <!-- Tab selection for Card/GCash -->
        <div class="payment-tabs" style="display: flex; gap: 10px;">
            <button type="button" onclick="showPaymentForm('card')" id="tab-card" class="tab-btn" style="flex:1; padding:10px; border:1px solid #ddd; background:#FBCD36;">Credit/Debit Card</button>
            <button type="button" onclick="showPaymentForm('gcash')" id="tab-gcash" class="tab-btn" style="flex:1; padding:10px; border:1px solid #ddd; background:white;">GCash</button>
        </div>

        <input type="hidden" name="method_type" value="Card" id="payment-method-type">

        <!-- Card Form Fields -->
        <div id="card-fields">
            <input type="text" name="card_number" id="card_number" class="styled-input" placeholder="Card Number (16 digits)" maxlength="16" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <div style="display:flex; gap:15px;">
                <input type="text" name="expiry" id="expiry" class="styled-input" placeholder="MM/YY" maxlength="5" style="flex:1;" oninput="formatExpiry(this)">
                <input type="text" name="cvv" id="cvv" class="styled-input" placeholder="CVV (3 digits)" maxlength="3" style="flex:1;" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
        </div>

        <!-- GCash Form Fields -->
        <div id="gcash-fields" style="display:none;">
            <input type="text" name="gcash_number" id="gcash_number" class="styled-input" placeholder="GCash Mobile Number (09xxxxxxxxx)" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>

        <!-- Set as Default Checkbox -->
        <label style="display:flex; align-items:center; gap:10px; font-size:0.9rem; color:#555 !important;">
            <input type="checkbox" name="is_default" value="true" checked>
            <span style="color:#555;">Set as Default</span>
        </label>

        <button type="submit" class="btn-add" style="background-color:#FBCD36; color:#550508; font-weight:700; font-size:1.1rem; padding:12px; border-radius:8px; border:none; cursor:pointer;">
            Add
        </button>
    </form>
</div>

<style>
    .set-default-link {
        font-size: 0.8rem;
        color: #007bff;
        text-decoration: none;
    }
    .set-default-link:hover {
        text-decoration: underline;
    }
</style>

<script>
    // Initial State Setup
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the initial state is Card
        showPaymentForm('card');
    });

    // Tab Switching Logic
    function showPaymentForm(type) {
        document.getElementById('payment-method-type').value = (type === 'card' ? 'Card' : 'GCash');
        document.getElementById('card-fields').style.display = (type === 'card' ? 'block' : 'none');
        document.getElementById('gcash-fields').style.display = (type === 'gcash' ? 'block' : 'none');

        // Aesthetic Tab Styling (Active tab is yellow)
        document.getElementById('tab-card').style.background = (type === 'card' ? '#FBCD36' : 'white');
        document.getElementById('tab-gcash').style.background = (type === 'gcash' ? '#FBCD36' : 'white');

        document.getElementById('tab-card').style.color = (type === 'card' ? '#550508' : '#555');
        document.getElementById('tab-gcash').style.color = (type === 'gcash' ? '#550508' : '#555');
    }

    function formatExpiry(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        input.value = value;
    }

    function validatePaymentForm() {
        const methodType = document.getElementById('payment-method-type').value;

        if (methodType === 'Card') {
            const cardNumber = document.getElementById('card_number').value;
            const expiry = document.getElementById('expiry').value;
            const cvv = document.getElementById('cvv').value;

            if (cardNumber.length !== 16) {
                alert('Card number must be 16 digits.');
                return false;
            }
            if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                alert('Expiry date must be in MM/YY format.');
                return false;
            }
            // Basic expiry validation (check if month is 01-12)
            const month = parseInt(expiry.substring(0, 2));
            if (month < 1 || month > 12) {
                alert('Invalid month in expiry date.');
                return false;
            }
            if (cvv.length !== 3) {
                alert('CVV must be 3 digits.');
                return false;
            }
        } else if (methodType === 'GCash') {
            const gcashNumber = document.getElementById('gcash_number').value;
            if (!/^09\d{9}$/.test(gcashNumber)) {
                alert('GCash number must start with 09 and be 11 digits long.');
                return false;
            }
        }
        return true;
    }
</script>
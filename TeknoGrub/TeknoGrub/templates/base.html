{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeknoGrub | {% block title %}Home{% endblock %}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{% static 'css/global_layout.css' %}?v=2">
    <link rel="stylesheet" href="{% static 'cart/css/cart_component.css' %}?v=2">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Background Gear (Only visible when NOT logged in) -->
    {% if not user.is_authenticated %}
    <img src="{% static 'images/school_logo.png' %}" class="background-watermark" alt="Background Logo">
    {% endif %}

    <div class="app-container {% if not user.is_authenticated %}auth-mode{% endif %}">

        <!-- LOGGED OUT: Public Header -->
        {% if not user.is_authenticated %}
            <header class="public-header">
                <div class="logo-small">TEKNO<span>GRUB</span></div>
                <div class="public-nav">
                    {% if request.resolver_match.url_name == 'signup' %}
                        <a href="{% url 'login' %}">Log In</a>
                    {% else %}
                        <a href="{% url 'signup' %}">Sign Up</a>
                    {% endif %}
                    <a href="#">About Us</a>
                </div>
            </header>
        {% endif %}

        <!-- LOGGED IN: Sidebar & Top Header -->
        {% if user.is_authenticated %}
            <aside class="sidebar" id="sidebar">
                <div class="logo">TEKNO<span>GRUB</span></div>

                <div class="user-profile-summary">
                    <h4>{{ request.user.first_name }} {{ request.user.last_name }}</h4>
                    <p>{{ request.user.id_number }}</p>
                </div>

                <!-- Canteen Selector - Only show to Students -->
                {% if user.role.role_name == 'Student' %}
                <div class="canteen-selector-wrapper" style="margin-bottom: 1.5rem;">
                    <form method="POST" action="{% url 'set_canteen' %}" class="canteen-selector-form">
                        {% csrf_token %}
                        <div class="canteen-display">
                            <i class="fa-solid fa-store" style="margin-right:10px; color:#550508;"></i>
                            <select name="canteen_id" onchange="this.form.submit()">
                                {% for c in canteens_list %}
                                <option value="{{ c.id }}" {% if request.session.canteen_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                                {% endfor %}
                            </select>
                            <i class="fa-solid fa-chevron-down" style="color:#550508;"></i>
                        </div>
                    </form>
                </div>
                {% endif %}

                <!-- Nav Links -->
                <div class="nav-container">
                    <ul class="nav-links">
                        {% if user.role.role_name == 'Admin' or user.is_superuser %}
                            <li><a href="{% url 'admin_dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}"><i class="fa-solid fa-chart-line"></i> Dashboard</a></li>
                            <li><a href="{% url 'staff_orders' %}" class="nav-link {% if request.resolver_match.url_name == 'staff_orders' %}active{% endif %}"><i class="fa-solid fa-receipt"></i> Orders</a></li>
                            <li><a href="{% url 'inventory' %}" class="nav-link"><i class="fa-solid fa-box"></i> Inventory</a></li>
                            <li><a href="{% url 'categories' %}" class="nav-link"><i class="fa-solid fa-tags"></i> Menu Categories</a></li>
                        {% elif user.role.role_name == 'Staff' %}
                            <li><a href="{% url 'staff_orders' %}" class="nav-link {% if request.resolver_match.url_name == 'staff_orders' %}active{% endif %}"><i class="fa-solid fa-receipt"></i> Orders</a></li>
                        {% else %}
                            <li><a href="{% url 'menu' %}" class="nav-link"><i class="fa-solid fa-utensils"></i> Menu</a></li>
                            <li><a href="{% url 'favorites' %}" class="nav-link"><i class="fa-solid fa-star"></i> Favorites</a></li>
                            <li><a href="{% url 'promos' %}" class="nav-link"><i class="fa-solid fa-percent"></i> Promos</a></li>
                            <li><a href="{% url 'history' %}" class="nav-link"><i class="fa-solid fa-clock-rotate-left"></i> History</a></li>
                        {% endif %}

                        <li><a href="{% url 'settings' %}" class="nav-link {% if request.resolver_match.url_name == 'settings' %}active{% endif %}"><i class="fa-solid fa-gear"></i> Settings</a></li>
                        <li><a href="{% url 'logout' %}" class="nav-link logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
                    </ul>
                </div>
            </aside>

            <header class="top-header">
                <button class="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fa-solid fa-bars"></i></button>
                <div class="header-icons">
                    <div class="notification-wrap">
                        <i class="fa-solid fa-bell"></i>
                        <span class="badge" id="notif-count" style="display:none">0</span>
                    </div>
                </div>
            </header>
        {% endif %}

        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    {% if user.is_authenticated and user.role.role_name != 'Admin' and user.role.role_name != 'Staff' %}
        {% include 'cart/cart_component.html' %}
    {% endif %}

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Cart & Favorites Logic
        function toggleFavorite(itemId, btn) {
            fetch(`/menu/favorite/toggle/${itemId}/`, {headers: {'X-CSRFToken': getCookie('csrftoken')}})
            .then(r => r.json()).then(d => {
                if (d.status === 'redirect') {
                    window.location.href = d.url;
                } else {
                    const icon = btn.querySelector('i');
                    if (d.status === 'added') {
                        icon.classList.replace('fa-regular', 'fa-solid');
                        icon.classList.add('favorited');
                    }
                    else {
                        icon.classList.replace('fa-solid', 'fa-regular');
                        icon.classList.remove('favorited');
                    }
                }
            });
        }

        {% if user.is_authenticated %}
        setInterval(() => {
            fetch('/api/notifications/get/')
            .then(r => r.json())
            .then(d => {
                const badge = document.getElementById('notif-count');
                if(d.count > 0) {
                    badge.innerText = d.count;
                    badge.style.display = 'flex';
                }
            });
        }, 5000);
        {% endif %}
    </script>
</body>
</html>
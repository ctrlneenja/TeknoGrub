{% extends 'base.html' %}
{% load static %}
{% block title %}Settings{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/settings_responsive.css' %}">
{% endblock %}

{% block content %}
<div class="settings-container">
    <h1 class="page-title" style="color:white; text-align:center;">Settings</h1>

    <!-- Two-Column Grid for Main Info & Account -->
    <div class="info-grid">
        <!-- LEFT COLUMN: Personal Info (Always displayed) -->
        <div class="settings-card personal-info-card">
            <h3 class="card-header">Personal Information</h3>
            <div class="card-row"><span class="label">ID Number</span><span class="value">{{ user.id_number }}</span></div>
            <div class="card-row"><span class="label">Full Name</span><span class="value">{{ user.first_name }} {{ user.last_name }}</span></div>
            <div class="card-row"><span class="label">School Email</span><span class="value">{{ user.school_email }}</span></div>
        </div>

        <!-- RIGHT COLUMN: Account Settings (Always displayed) -->
        <div class="settings-card account-actions-card">
            <h3 class="card-header">Account</h3>

            <div class="setting-item clickable">
                <a href="{% url 'password_change' %}" style="text-decoration:none; color:inherit; display:flex; justify-content:space-between; width:100%;">
                    <span>Change Password</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </a>
            </div>

            <!-- Payment Methods Link (Only for Users who can order) -->
            {% if user.role.role_name == 'Student' %}
            <div class="setting-item clickable" onclick="openPaymentModal()">
                <span>Payment Methods</span>
                <i class="fa-solid fa-chevron-right"></i>
            </div>
            {% endif %}

            <div class="setting-item delete"><span>Delete Account</span></div>
        </div>
    </div>

    <!-- FIX: Activity Summary Card (Only for Students) -->
    {% if user.role.role_name == 'Student' %}
    <div class="settings-card activity-summary-card">
        <h3 class="card-header">Activity Summary</h3>
        <div class="card-row"><span class="label">Total Orders</span><span class="value">{{ orders_count }}</span></div>
        <div class="card-row"><span class="label">Favorites</span><span class="value">{{ fav_count }}</span></div>
    </div>
    {% endif %}

    <!-- Logout Button Container -->
    <div class="logout-container">
        <a href="{% url 'logout' %}" class="btn-logout">Logout</a>
    </div>
</div>


<!-- ============================================== -->
<!-- PAYMENT MODAL CONTAINER (The Popup)            -->
<!-- The core structure for the payment modal -->
<!-- ============================================== -->
<div id="paymentModalOverlay" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:5000; justify-content:center; align-items:center;">
    <div class="modal-content-wrapper" style="background:white; width:90%; max-width:600px; border-radius:12px; padding:20px; position:relative;">
        {% include 'Payment/payment_modal_content.html' %}
    </div>
</div>

<script>
    // Functions for Modal Control
    function openPaymentModal() {
        document.getElementById('paymentModalOverlay').style.display = 'flex';
    }
    function closePaymentModal() {
        document.getElementById('paymentModalOverlay').style.display = 'none';
    }
</script>

<!-- DELETE Confirmation Modal -->
<div id="deleteConfirmationModal" class="modal-overlay" style="display:none; z-index:6000; justify-content:center; align-items:center;">
    <div class="delete-box" style="background:white; padding:30px; border-radius:10px; text-align:center;">
        <h3 style="color:#550508; font-size:1.5rem;">Are you sure you want to delete this method?</h3>
        <p style="color:#888; margin-top:10px;">This action cannot be undone.</p>
        <div style="margin-top:20px;">
            <button onclick="closeDeleteConfirmationModal()" style="padding:10px 20px; border:1px solid #ccc; border-radius:5px; margin-right:15px; cursor:pointer;">Cancel</button>
            <a id="confirmDeleteLink" href="#" class="btn-delete" style="padding:10px 20px; border:none; border-radius:5px; background:#d32f2f; color:white; text-decoration:none;">Delete</a>
        </div>
    </div>
</div>

<script>
    // JS for the Delete Confirmation Modal
    function openDeleteConfirmationModal(methodId) {
        document.getElementById('confirmDeleteLink').href = '/payment/delete/' + methodId + '/';
        document.getElementById('deleteConfirmationModal').style.display = 'flex';
    }
    function closeDeleteConfirmationModal() {
        document.getElementById('deleteConfirmationModal').style.display = 'none';
    }
</script>
{% endblock %}